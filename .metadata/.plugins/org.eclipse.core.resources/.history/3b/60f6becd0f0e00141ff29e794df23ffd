package com.laurenelder.movielookup;

import java.io.InputStream;

import android.app.Activity;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.ImageView;
import android.widget.RatingBar;
import android.widget.RatingBar.OnRatingBarChangeListener;
import android.widget.TextView;

public class DetailActivity extends Activity {
	
	static String tag = "DETAILSACTIVITY";
	ImageView image;
	TextView titleTxt;
	TextView yearTxt;
	TextView directorTxt;
	TextView ratedTxt;
	TextView runtimeTxt;
	TextView genreTxt;
	TextView actorTxt;
	TextView awardTxt;
	TextView scoreTxt;
	TextView plotTxt;
	RatingBar rBar;
//	Float ratingValue;
	Bitmap moviePoster;
	Intent intent;
	
	String TITLE;
	String IMAGEURL;
	Float FAV;
	String YEAR;
	String DIRECTOR;
	String RATED;
	String RUNTIME;
	String GENRE;
	String ACTORS;
	String AWARDS;
	String SCORE;
	String PLOT;
	

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		setContentView(R.layout.detail_layout);
		super.onCreate(savedInstanceState);
		
		intent = this.getIntent();
		
		titleTxt = (TextView)findViewById(R.id.movieTitle);
		yearTxt = (TextView)findViewById(R.id.movieYear);
		directorTxt = (TextView)findViewById(R.id.movieDirector);
		ratedTxt = (TextView)findViewById(R.id.movieRating);
		runtimeTxt = (TextView)findViewById(R.id.movieRuntime);
		genreTxt = (TextView)findViewById(R.id.movieGenre);
		actorTxt = (TextView)findViewById(R.id.movieActor);
		awardTxt = (TextView)findViewById(R.id.movieAwards);
		scoreTxt = (TextView)findViewById(R.id.movieScore);
		plotTxt = (TextView)findViewById(R.id.moviePlot);
		image = (ImageView)findViewById(R.id.movieImage);
		rBar = (RatingBar)findViewById(R.id.ratingBar);
		
//		imageURL = getIntent().getExtras().getString("image");
		
		TITLE = intent.getExtras().getString("title");
		IMAGEURL = intent.getExtras().getString("image");
		FAV = rBar.getRating();
		YEAR = intent.getExtras().getString("year");
		DIRECTOR = intent.getExtras().getString("director");
		RATED = intent.getExtras().getString("rated");
		RUNTIME = intent.getExtras().getString("runtime");
		GENRE = intent.getExtras().getString("genre");
		ACTORS = intent.getExtras().getString("actors");
		AWARDS = intent.getExtras().getString("awards");
		SCORE = intent.getExtras().getString("score");
		PLOT = intent.getExtras().getString("plot");
		
//		new downloadImage().execute(imageURL);
		new downloadImage().execute(IMAGEURL);
		
/*		titleTxt.setText(intent.getExtras().getString("title"));
		yearTxt.setText(intent.getExtras().getString("year"));
		directorTxt.setText(intent.getExtras().getString("director"));
		ratedTxt.setText(intent.getExtras().getString("rated"));
		runtimeTxt.setText(intent.getExtras().getString("runtime"));
		genreTxt.setText(intent.getExtras().getString("genre"));
		actorTxt.setText(intent.getExtras().getString("actors"));
		awardTxt.setText(intent.getExtras().getString("awards"));
		scoreTxt.setText(intent.getExtras().getString("score"));
		plotTxt.setText(intent.getExtras().getString("plot"));*/
		
		titleTxt.setText(TITLE);
		yearTxt.setText(YEAR);
		directorTxt.setText(DIRECTOR);
		ratedTxt.setText(RATED);
		runtimeTxt.setText(RUNTIME);
		genreTxt.setText(GENRE);
		actorTxt.setText(ACTORS);
		awardTxt.setText(AWARDS);
		scoreTxt.setText(SCORE);
		plotTxt.setText(PLOT);
		
//		ratingValue = rBar.getRating();
		
		rBar.setOnRatingBarChangeListener(new OnRatingBarChangeListener() {

			@Override
			public void onRatingChanged(RatingBar ratingBar, float rating,
					boolean fromUser) {
				// TODO Auto-generated method stub
//				ratingValue = rBar.getRating();
				FAV = rBar.getRating();
			}
			
		});
		
		image.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {
				// TODO Auto-generated method stub
				Log.i(tag, "User Clicked on Image!!");
//				Uri website = Uri.parse(imageURL);
				Uri website = Uri.parse(IMAGEURL);
				Intent websiteIntent = new Intent(Intent.ACTION_VIEW, website);
				startActivity(websiteIntent);
			}
		});
	}

	private class downloadImage extends AsyncTask<String, Void, Bitmap> {

		protected Bitmap doInBackground(String... urls) {
			String urldisplay = urls[0];
			Bitmap moviePoster = null;
			try {
				InputStream stream = new java.net.URL(urldisplay).openStream();
				moviePoster = BitmapFactory.decodeStream(stream);
			} catch (Exception e) {
				Log.e("Error", e.getMessage());
				e.printStackTrace();
			}
			return moviePoster;
		}

		protected void onPostExecute(Bitmap result) {
			image.setImageBitmap(result);
		}
	} 
	
	@Override
	public void finish() {
	  // Prepare data intent 
	  Intent data = new Intent();
	  data.putExtra("fav", FAV);
	  data.putExtra("title", titleTxt.getText().toString());
	  // Activity finished ok, return the data
	  setResult(RESULT_OK, data);
	  super.finish();
	} 
	
	@Override public void onBackPressed() { 
		super.onBackPressed(); 
		finish(); 
		}
	
	@Override
	public void onSaveInstanceState(Bundle savedInstanceState) {
	  super.onSaveInstanceState(savedInstanceState);
	  // Save UI state changes to the savedInstanceState.
	  savedInstanceState.putString("TITLE", TITLE);
	  savedInstanceState.putString("IMAGE", IMAGEURL);
	  savedInstanceState.putFloat("FAV", FAV);
	  savedInstanceState.putString("YEAR", YEAR);
	  savedInstanceState.putString("DIRECTOR", DIRECTOR);
	  savedInstanceState.putString("RATED", RATED);
	  savedInstanceState.putString("RUNTIME", RUNTIME);
	  savedInstanceState.putString("GENRE", GENRE);
	  savedInstanceState.putString("ACTORS", ACTORS);
	  savedInstanceState.putString("AWARDS", AWARDS);
	  savedInstanceState.putString("SCORE", SCORE);
	  savedInstanceState.putString("PLOT", PLOT);
	}
	
	@Override
	protected void onRestoreInstanceState(Bundle savedInstanceState) {
	    super.onRestoreInstanceState(savedInstanceState);
	    // read your previously saved data
		TITLE = savedInstanceState.getString("TITLE");
		IMAGEURL = savedInstanceState.getString("IMAGE");
		FAV = savedInstanceState.getFloat("FAV");
		YEAR = savedInstanceState.getString("YEAR");
		DIRECTOR = savedInstanceState.getString("DIRECTOR");
		RATED = savedInstanceState.getString("RATED");
		RUNTIME = savedInstanceState.getString("RUNTIME");
		GENRE = savedInstanceState.getString("GENRE");
		ACTORS = savedInstanceState.getString("ACTORS");
		AWARDS = savedInstanceState.getString("AWARDS");
		SCORE = savedInstanceState.getString("SCORE");
		PLOT = savedInstanceState.getString("PLOT");
	}
}
