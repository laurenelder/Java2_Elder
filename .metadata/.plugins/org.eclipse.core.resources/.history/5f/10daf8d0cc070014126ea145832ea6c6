/*
 * Project:			MovieLookup
 * Package:			com.laurenelder.movielookup
 * Author:			Devin "Lauren" Elder
 * Date:			Jul 9, 2014
 * Class:			Java 2 Term 1407
 */

package com.laurenelder.movielookup;

import java.net.MalformedURLException;
import java.net.URL;

import android.app.IntentService;
import android.content.Intent;
import android.os.AsyncTask;
import android.util.Log;

public class ApiService extends IntentService {
	static String tag = "MAINACTIVITY";

	public ApiService() {
		super("ApiService");
		// TODO Auto-generated constructor stub
	}

	@Override
	protected void onHandleIntent(Intent intent) {
		// TODO Auto-generated method stub
		
	    // API Method
	    public String getAPIresponse(URL url) {
	    	String apiResponse = "";
	    	try {
				URLConnection apiConnection = url.openConnection();
				BufferedInputStream bufferedInput = new BufferedInputStream(apiConnection
						.getInputStream());
				byte[] contextByte = new byte[1024];
				int bytesRead = 0;
				StringBuffer responseBuffer = new StringBuffer();
				while ((bytesRead = bufferedInput.read(contextByte)) != -1) {
					apiResponse = new String(contextByte, 0, bytesRead);
					responseBuffer.append(apiResponse);
				}
				apiResponse = responseBuffer.toString();
//				Log.i(tag, apiResponse);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				Log.i(tag, "getAPIresponse - no data returned");
				e.printStackTrace();
			}
	    	Log.i(tag, apiResponse.toString());
	    	return apiResponse;
	    }
	    
	    // API Class
	    class getAPIdata extends AsyncTask<String, Void, String> {

			@Override
			protected void onPreExecute() {
				// TODO Auto-generated method stub
				super.onPreExecute();

				// Show Animation
				animation.setVisibility(View.VISIBLE);
			}
			@Override
			protected String doInBackground(String... params) {
				// TODO Auto-generated method stub
				String APIresponseStr = "";

				// API Call based on Selected API
				try {
					URL url = null;
					if (game == true && details == false && stores == false) {
						url = new URL(currentURL);
					}
					if (game == false && details == false && stores == true) {
						url = new URL(context.getString(R.string.store_url));
					}
					if (game == false && details == true && stores == false) {
						url = new URL(currentURL);
					}
					APIresponseStr = getAPIresponse(url);
				} catch (MalformedURLException e) {
					// TODO Auto-generated catch block
					Log.i(tag, "Something went wrong in getAPIdata");
					e.printStackTrace();
				}
				return APIresponseStr;
			}
			
			@Override
			protected void onPostExecute(String result) {
//				Log.i(tag, result);
				super.onPostExecute(result);

				// Hide Animation
//				animation.setVisibility(View.GONE);

			}
	    }
		
	}

}
